# UI Fixes - November 2, 2025

## Issues Fixed

### 1. LoRA Fetching Error
**Problem:** The `getAvailableLoras()` function was failing with error `api.getObjectInfo is not a function`.

**Solution:** 
- Added a new server endpoint `/autopilot_lora/available` that directly fetches LoRAs from ComfyUI's `folder_paths.get_filename_list("loras")`
- Updated `getAvailableLoras()` to:
  1. **First** try the new `/autopilot_lora/available` endpoint (fastest and most reliable)
  2. **Fallback** to the existing `api.getObjectInfo()` method if the endpoint fails
- This ensures manual LoRA selection works properly without API errors

### 2. Indexing "Assignment to Constant Variable" Error
**Problem:** When clicking "Start Indexing" button, the browser showed error: `Indexing failed: Assignment to constant variable.`

**Solution:**
- Fixed the catalog refresh logic in the indexing button's success handler
- Changed from reassigning `catalog` (which was declared as `const`) to:
  ```javascript
  // Create new catalog from API
  const newCatalog = newCatalogResponse.ok ? await newCatalogResponse.json() : {};
  // Clear and update existing catalog object
  Object.keys(catalog).forEach(key => delete catalog[key]);
  Object.assign(catalog, newCatalog);
  ```
- This properly updates the catalog in-place without reassignment

### 3. Missing "Toggle All" Button and "Strength" Label
**Problem:** The manual LoRA section was missing:
- A "Toggle All" button to enable/disable all manual LoRAs at once
- A "Strength" label to indicate what the number sliders control

**Solution:**
- Created a new `ManualLoraHeaderWidget` class that displays:
  - **Toggle All button** with visual feedback (shows state: all on/all off/mixed)
  - **"Toggle All" text label** next to the button
  - **"Strength" label** on the right side, matching the rgthree original design
- The header widget:
  - Only appears when there are manual LoRAs (hidden when empty)
  - Properly handles click events to toggle all manual LoRAs
  - Uses the same visual style as the original rgthree Power LoRA Loader
- Added the header widget to the node creation flow, inserted after the spacer and before the "Add Manual LoRA" button

### 4. Context Menu "Toggle All" Option
**Problem:** While not broken, the existing context menu option wasn't visible enough.

**Solution:**
- Kept the existing context menu "Toggle All Manual LoRAs" option as an alternative access method
- Now users have two ways to toggle all LoRAs:
  1. Click the header widget's toggle button (visual, always visible)
  2. Right-click and select "Toggle All Manual LoRAs" from context menu

## Files Modified

### `server.py`
- Added new endpoint: `GET /autopilot_lora/available`
  - Returns all LoRAs from `folder_paths.get_filename_list("loras")`
  - Provides reliable fallback for LoRA list fetching

### `web/smart_power_lora_loader.js`
- **Fixed `getAvailableLoras()`**: Added primary endpoint + fallback logic
- **Fixed indexing error**: Changed catalog update to use `Object.assign()` instead of reassignment
- **Added `ManualLoraHeaderWidget` class**: New widget for header with toggle button and labels
- **Updated node creation**: Integrated header widget into the widget stack

## Testing Recommendations

1. **LoRA Fetching**: 
   - Click "Add Manual LoRA" button
   - Verify the LoRA chooser dialog appears without errors
   - Confirm all available LoRAs are listed

2. **Indexing**:
   - Add some unindexed LoRAs to your LoRA folder
   - Click "ðŸ”„ Start Indexing" in the catalog dialog
   - Verify no console errors appear
   - Check that success notification shows correct counts

3. **Toggle All Button**:
   - Add 2-3 manual LoRAs
   - Verify the header appears with toggle button and "Strength" label
   - Click the toggle button - all LoRAs should turn off
   - Click again - all should turn on
   - Toggle individual LoRAs to create mixed state
   - Click toggle button - all should turn on

4. **Context Menu**:
   - Right-click the node
   - Verify "Toggle All Manual LoRAs" option appears (when manual LoRAs exist)
   - Test that it works as expected

## Architecture Notes

The header widget follows the same design patterns as rgthree's original Power LoRA Loader:
- Uses custom widget with `draw()` and `mouse()` methods
- Implements hit area detection for interactive elements
- Properly handles canvas alpha for consistent UI appearance
- Only renders when relevant (has manual LoRAs)
- Integrates seamlessly with ComfyUI's widget system

## Future Improvements

- Consider adding keyboard shortcuts for toggle all (e.g., Ctrl+T)
- Add visual indication of which LoRAs are auto-selected vs manual
- Implement drag-and-drop reordering of manual LoRAs
- Add bulk edit mode for changing multiple LoRA strengths at once
