# Bug Fixes - November 2, 2025

## Issues Fixed

### 1. **Auto-populate Catalog with All LoRAs on Startup**
**Problem:** Only indexed LoRAs were in the JSON catalog file, causing enable/disable toggles to not persist for non-indexed LoRAs.

**Solution:** Modified `startup.py` to automatically scan all LoRA files in the LoRA directory and add them to the catalog with **basic metadata only (NO LLM indexing)** on startup. All new LoRAs are:
- Added to the JSON catalog with minimal metadata (just file info)
- Marked as `enabled: True` by default
- Marked as `indexed_by_llm: False` (NOT indexed - requires manual indexing button)
- Have `available: True` status

**IMPORTANT:** This does NOT run LLM indexing. It only adds basic file information to allow persistent enable/disable state. Full LLM indexing still requires manually clicking the Index button.

**Files Changed:**
- `startup.py`: Added auto-population logic to scan and add all LoRAs to catalog with basic metadata only

### 2. **Fix Enable/Disable State Persistence for All LoRAs**
**Problem:** Enable/disable toggles in the catalog dialog only persisted for indexed LoRAs. Non-indexed LoRAs would reset their state when closing and reopening the dialog.

**Solution:** 
- Updated `server.py` `/autopilot_lora/update` endpoint to create minimal catalog entries for LoRAs that don't exist yet
- Updated JavaScript toggle button logic to handle both indexed and non-indexed LoRAs
- Added file-to-hash mapping to track LoRA files in the catalog
- Toggle state now persists for ALL LoRAs regardless of indexing status

**Files Changed:**
- `server.py`: Updated `/autopilot_lora/update` to create entries for non-indexed LoRAs
- `web/smart_power_lora_loader.js`: Updated catalog dialog to handle file-to-hash mapping and persist state for all LoRAs

### 3. **Fix Header Widget Z-Order Issue**
**Problem:** When adding manual LoRAs, the header widget (with "Toggle All" button and "Strength" label) would be covered by manual LoRA widgets, making it appear in the background.

**Solution:** 
- Added `onDrawForeground` override to the node to re-draw the header widget on top of all other widgets
- This ensures the header is always visible above manual LoRA widgets
- Also improved manual LoRA insertion logic to insert after the last manual LoRA

**Files Changed:**
- `web/smart_power_lora_loader.js`: 
  - Added `onDrawForeground` to draw header widget on top
  - Improved "Add Manual LoRA" button logic to insert at correct position

## Technical Details

### Startup Flow
1. ComfyUI loads the Autopilot LoRA Loader extension
2. `startup.py` runs the `startup_check()` function
3. All LoRA files (*.safetensors, *.ckpt) are scanned
4. Missing LoRAs are added to the catalog with **basic metadata only (NO LLM processing)**
5. Catalog is saved to `data/lora_index.json`
6. **Full LLM indexing only happens when you manually click the Index button**

### Catalog Entry Structure (Basic Entry - NOT Indexed)
```json
{
  "file_hash_value": {
    "file_hash": "hash_value",
    "file": "lora_name.safetensors",
    "full_path": "/path/to/lora",
    "display_name": "Lora Name",
    "sha256": "hash_value",
    "available": true,
    "summary": "",
    "trained_words": [],
    "tags": [],
    "is_character": false,
    "enabled": true,
    "base_compat": ["Unknown"],
    "default_weight": 1.0,
    "source": {"kind": "unknown"},
    "indexed_at": null,
    "indexed_by_llm": false  // ← NOT indexed, requires manual indexing
  }
}
```

### API Changes
- **POST `/autopilot_lora/update`**: Now accepts `file_name` parameter to create entries for non-indexed LoRAs
  - If `file_hash` exists in catalog: updates the entry
  - If `file_hash` doesn't exist but `file_name` provided: creates minimal entry then updates

### Widget Drawing Order
- Widgets are normally drawn in order from their position in the widgets array
- Header widget is added early but needs to appear on top
- Solution: `onDrawForeground` re-draws the header widget after all other drawing is complete
- This ensures the header is always visible and interactive

## Testing Checklist

✅ All LoRAs appear in catalog on first startup
✅ Enable/disable state persists for indexed LoRAs
✅ Enable/disable state persists for non-indexed LoRAs
✅ Header widget (Toggle All + Strength) appears on top of manual LoRAs
✅ Manual LoRA insertion works correctly
✅ Catalog saves and loads properly

## User Impact

**Before:**
- Only indexed LoRAs could have persistent enable/disable state
- Non-indexed LoRAs would reset to enabled on dialog reopen
- Header widget could be covered by manual LoRA widgets

**After:**
- ALL LoRAs (indexed and non-indexed) have persistent enable/disable state
- LoRAs are automatically added to catalog on startup
- Header widget always visible on top of manual LoRAs
- Cleaner user experience with consistent behavior

## Notes

- The startup process now takes slightly longer due to file scanning and hash computation
- All LoRAs are added to catalog, even if not fully indexed
- This prevents wasting API calls on disabled LoRAs
- The `indexed_by_llm` field distinguishes between basic catalog entries and fully indexed LoRAs
